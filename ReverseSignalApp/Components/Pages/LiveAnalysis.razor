@page "/live-analysis"
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@using ReverseSignalApp.Services
@using System.Diagnostics


@inject IJSRuntime JS

<h3 class="mb-3">⚽ Canlı Maç Analizi</h3>

<div class="mb-3">
    <button class="btn btn-outline-primary" @onclick="LoadLiveMatchesAsync" disabled="@isLoading">
        🔄 Canlı Maçları Yenile
    </button>
</div>

@if (isLoading)
{
    <div class="d-flex align-items-center">
        <div class="spinner-border text-info me-2" role="status">
            <span class="visually-hidden">Yükleniyor...</span>
        </div>
        <strong>@loadingMessage</strong>
    </div>
}
else if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">@errorMessage</div>
}
else if (liveMatches.Count == 0)
{
    <div class="alert alert-warning">Şu anda canlı maç bulunamadı.</div>
}
else
{
    <div class="mb-3">
        <label class="form-label">Bir maç seçin:</label>
        <select class="form-select" @onchange="OnMatchChanged" disabled="@isAnalyzing">
            <option value="">-- Seçiniz --</option>
            @foreach (var match in liveMatches)
            {
                <option value="@match.Id">@match.HomeTeam.Name @match.Score?.Home - @match.Score?.Away @match.AwayTeam.Name (@match.Status)</option>
            }
        </select>
    </div>

    <div class="mb-3">
        <button class="btn btn-success" @onclick="StartAnalysisAsync">
            🚀 Analizi Başlat
        </button>
    </div>
}

@if (isAnalyzing)
{
    <div class="d-flex align-items-center">
        <div class="spinner-border text-success me-2" role="status">
            <span class="visually-hidden">Analiz ediliyor...</span>
        </div>
        <strong>Analiz devam ediyor...</strong>
    </div>
}

@if (!string.IsNullOrEmpty(analysisResult))
{
    <div class="card mt-4 shadow-sm">
        <div class="card-body">
            <h5 class="card-title">🤖 LLaMA Analizi</h5>
            <pre style="white-space: pre-wrap; word-break: break-word;">@SplitLongLines(analysisResult, 100)</pre>

        </div>
    </div>
}

@code {
    private List<MatchModel> liveMatches = new();
    private bool isLoading = false;
    private bool isAnalyzing = false;
    private string? selectedMatchId;
    private string? errorMessage;
    private string? loadingMessage;
    private string? analysisResult;

    protected override async Task OnInitializedAsync()
    {
        await LogAsync("🧠 Component initialized");
        await LoadLiveMatchesAsync();
    }

    private async Task LoadLiveMatchesAsync()
    {
        await LogAsync("📡 Loading live matches...");
        try
        {
            isLoading = true;
            loadingMessage = "Canlı maçlar yükleniyor...";
            errorMessage = null;
            liveMatches.Clear();

            var list = await FootballDataService.Instance.GetLiveTodayAsync();
            liveMatches = list ?? new();

            await LogAsync($"✅ Loaded {liveMatches.Count} matches");

            if (liveMatches.Count == 0)
                errorMessage = "Şu anda analiz edilebilir canlı maç yok.";
        }
        catch (Exception ex)
        {
            errorMessage = $"Maçlar yüklenirken hata: {ex.Message}";
            await LogAsync($"❌ Error while loading matches: {ex}");
        }
        finally
        {
            isLoading = false;
            loadingMessage = null;
        }
    }

    private void OnMatchChanged(ChangeEventArgs e)
    {
        selectedMatchId = e?.Value?.ToString()?.Trim();
        Console.WriteLine($"[DEBUG] SelectedMatchId = {selectedMatchId}");
        Debug.WriteLine($"[DEBUG] SelectedMatchId = {selectedMatchId}");
        JS.InvokeVoidAsync("console.log", $"[JS DEBUG] SelectedMatchId = {selectedMatchId}");
        StateHasChanged();
    }

    private async Task StartAnalysisAsync()
    {
        await LogAsync($"🚀 StartAnalysisAsync triggered with selectedMatchId={selectedMatchId}");

        if (string.IsNullOrWhiteSpace(selectedMatchId))
        {
            errorMessage = "Lütfen önce bir maç seçin.";
            await LogAsync("⚠️ StartAnalysisAsync aborted: match not selected");
            return;
        }

        try
        {
            isAnalyzing = true;
            errorMessage = null;
            analysisResult = null;

            var match = liveMatches.FirstOrDefault(m => m.Id.ToString() == selectedMatchId);
            if (match == null)
            {
                errorMessage = "Seçilen maç bulunamadı.";
                await LogAsync("⚠️ Match not found in list");
                return;
            }

            await LogAsync($"🧩 Context build started for match: {match.HomeTeam.Name} vs {match.AwayTeam.Name}");
            var context = await FootballDataService.Instance.BuildFocalContextAsync(match, 10);
            var stats = await FootballDataService.Instance.GetLiveStatisticsAsync(match.Id);
            await LogAsync("🧠 Running LLaMA analysis...");
            analysisResult = await LiveAnalysisService.Instance.AnalyzeLiveMatchAsync(match, context, stats);

            await LogAsync("✅ Analysis complete");
        }
        catch (Exception ex)
        {
            errorMessage = $"Analiz sırasında hata oluştu: {ex.Message}";
            await LogAsync($"❌ Exception: {ex}");
        }
        finally
        {
            isAnalyzing = false;
            StateHasChanged();
        }
    }

    private async Task LogAsync(string message)
    {
        Console.WriteLine(message);
        Debug.WriteLine(message);
        await JS.InvokeVoidAsync("console.log", message);
    }

    private static string SplitLongLines(string text, int maxLineLength)
    {
        if (string.IsNullOrWhiteSpace(text))
            return text;

        var lines = text.Split('\n');
        var builder = new System.Text.StringBuilder();

        foreach (var line in lines)
        {
            for (int i = 0; i < line.Length; i += maxLineLength)
            {
                int len = Math.Min(maxLineLength, line.Length - i);
                builder.AppendLine(line.Substring(i, len));
            }
        }

        return builder.ToString();
    }

}
